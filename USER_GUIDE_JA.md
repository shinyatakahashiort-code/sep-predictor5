# 👁️ SE予測アプリ 使用ガイド

## 📖 概要

このアプリは、眼科検査データから球面度数（SE）を予測し、自動的に近視・遠視の分類を行います。
単一患者の予測だけでなく、Excelファイルによる一括処理にも対応しています。

## 🎯 主な機能

### 1. SE分類メーター
予測値を自動的に以下のカテゴリーに分類します：

- **-10D未満**: 最強度近視 🔴
- **-10D〜-6D**: 強度近視 🟠
- **-6D〜-3D**: 中等度近視 🟡
- **-3D〜-0.5D**: 弱度近視 🟢
- **-0.5D〜0.5D**: 正視 ✅
- **0.5D以上**: 遠視 🔵

### 2. 単一患者予測
1人の患者データを入力して、13種類のモデルで予測を実行

### 3. 一括処理（バッチ処理）
Excelファイルから複数の患者データを読み込み、一度に予測を実行

## 🚀 使い方

### 単一患者モード

#### ステップ1: 言語選択
左側のサイドバーで「日本語」を選択

#### ステップ2: 入力モード選択
- 「単一患者」を選択

#### ステップ3: データ入力
以下の項目を入力：
- **年齢**: 0〜100歳
- **性別**: 男性(0) または 女性(1)
- **K（AVG）**: 平均角膜曲率半径（40.0〜50.0）
- **AL**: 眼軸長（20.0〜30.0 mm）
- **LT**: 水晶体厚（3.0〜6.0 mm）
- **ACD**: 前房深度（2.0〜4.0 mm）

#### ステップ4: 予測実行
「予測実行」ボタンをクリック

#### ステップ5: 結果確認
- **SE分類メーター**: 視覚的なゲージで分類を表示
- **Top 3モデル**: 最も性能の良い3つのモデルの予測値
- **全モデルの予測結果**: 全13モデルの詳細な予測値と分類
- **比較チャート**: モデル間の予測値を比較

### 一括処理モード

#### ステップ1: モード選択
サイドバーで「一括処理（Excel）」を選択

#### ステップ2: テンプレートダウンロード
「📥 テンプレートダウンロード」ボタンをクリックして、Excelテンプレートを取得

#### ステップ3: データ入力
ダウンロードしたテンプレートに患者データを入力

**必須カラム:**
- 年齢
- 性別（0=男性, 1=女性）
- K（AVG）
- AL
- LT
- ACD

**例:**
```
年齢  性別  K（AVG）   AL    LT   ACD
30    0     43.5    24.0  4.5  3.0
45    1     44.0    25.5  4.8  3.2
25    0     43.0    23.5  4.3  2.9
50    1     44.5    26.0  5.0  3.3
```

#### ステップ4: ファイルアップロード
完成したExcelファイルをアップロード

#### ステップ5: 処理実行
「一括処理実行」ボタンをクリック

#### ステップ6: 結果確認
- **基本統計量**: 平均値、中央値、標準偏差、範囲
- **分類分布**: 円グラフで各分類の割合を表示
- **詳細結果テーブル**: 全患者の予測結果
- **分布ヒストグラム**: SE値の分布を視覚化

#### ステップ7: 結果ダウンロード
「📥 結果をダウンロード」ボタンで、予測結果をExcelファイルとしてダウンロード

## 📊 結果の見方

### 単一患者の結果

#### SEメーター
- 針が指している位置: 予測されたSE値
- 色分けされた範囲: SE分類
- 絵文字: 分類カテゴリー

#### Top 3モデル
- 最も精度の高い3つのモデルの予測
- 各モデルの予測値と分類が表示
- R²スコアで性能を確認可能

#### 全モデル比較表
| 項目 | 説明 |
|------|------|
| モデル | 使用した機械学習モデル名 |
| 予測値 | 予測されたSE値（D: ジオプトリー） |
| 分類 | 近視・遠視の分類 |
| テストR² | モデルの精度（1.0に近いほど高精度） |
| テストRMSE | 予測誤差（小さいほど良い） |
| CV RMSE | クロスバリデーション誤差 |

### 一括処理の結果

#### 基本統計量
- **Mean**: 全患者のSE平均値
- **Median**: SE中央値
- **Std Dev**: 標準偏差（ばらつき）
- **Range**: 最大値と最小値の差

#### 分類分布
- 円グラフで各分類の患者数の割合を表示
- 集団の視力傾向を把握可能

#### ヒストグラム
- SE値の分布を視覚化
- 縦線で各分類の境界を表示
- 集団内のSE分布パターンを確認

## 💡 使用上のヒント

### 最適なモデル選択
- **Gradient Boosting**: 最もバランスが良く推奨
- **Extra Trees**: 高速で精度も高い
- **XGBoost**: 複雑なパターンに強い

### モデルの信頼性
- Test R²が0.95以上: 非常に高精度
- CV RMSEが小さい: 安定した予測
- 複数モデルの予測が近い: 信頼性が高い

### 一括処理のコツ
- 患者数が多い場合は時間がかかります
- 一度に処理できる患者数: 無制限（推奨は1000人以下）
- 結果は必ずダウンロードして保存

## ⚠️ 注意事項

### データ入力
- 全ての項目は必須です
- 範囲外の値は入力できません
- 性別は0（男性）または1（女性）

### 予測結果
- この予測は補助ツールです
- 最終的な診断は医師が行ってください
- 予測値は参考値として使用してください

### データプライバシー
- アップロードされたデータはサーバーに保存されません
- セッション終了後は全て削除されます
- 結果は必ずダウンロードして保存してください

## 🔧 トラブルシューティング

### Excelファイルがアップロードできない
- ファイル形式を確認（.xlsx または .xls）
- 必須カラム名が正しいか確認
- データに欠損値がないか確認

### 予測がエラーになる
- 入力値の範囲を確認
- データの形式を確認（数値のみ）
- テンプレートを再ダウンロードして使用

### 結果がダウンロードできない
- ブラウザのポップアップブロックを確認
- 十分な空き容量があるか確認
- 別のブラウザで試してみる

## 📞 サポート

問題が発生した場合は、以下を確認してください：
1. ブラウザを最新版に更新
2. キャッシュをクリア
3. 別のブラウザで試す
4. テンプレートを使用しているか確認

## 📚 参考情報

### モデル性能
| モデル | テストR² | テストRMSE | CV RMSE |
|--------|---------|-----------|---------|
| Gradient Boosting | 0.9640 | 0.7369 | 0.9030 |
| Extra Trees | 0.9609 | 0.7674 | 0.9017 |
| MLP | 0.9601 | 0.7753 | 1.4036 |
| XGBoost | 0.9562 | 0.8123 | 0.9912 |
| Ridge | 0.9547 | 0.8261 | 0.9182 |

### 分類基準
このアプリは臨床的に広く使用されている分類基準に基づいています：
- 近視は負の値（マイナス）
- 遠視は正の値（プラス）
- 正視は-0.5D〜+0.5Dの範囲

---

**このアプリは教育・研究目的のみです。医療上の判断については必ず専門医にご相談ください。**
